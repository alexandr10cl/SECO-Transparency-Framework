{% extends "base.html" %}

{% block head %}
 {# <link rel="stylesheet" href="{{ url_for('static', filename='dashboard/static/css/main.6328a2c2.css') }}"> #}
 <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
 <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
{% endblock %}

{% block title %}SECO Dashboard{% endblock %}

{% block content %}
{# 
    <div id="root"></div>
    <script src="{{ url_for('static', filename='dashboard/static/js/main.0344493c.js') }}"></script>
#}
<br><br>
<div class="dashboard-container">
    <div class="dashboard-title">
        <span class="material-symbols-outlined">analytics</span>
        <h2>Evaluation Dashboard: {{ evaluation.evaluation_id }}</h2>
    </div>
    <hr>

    <div class="evaluation-info">
        <div class="evaluation-info-card">
            <h3>Evaluated portal</h3>
            <h2>{{ ePortal }}</h2>
        </div>
        <!-- <div class="evaluation-info-card">
            <h3>Evaluation Date</h3>
            <h2>23/10/2025 - 23/11/2025</h2>
        </div> -->
        <div class="evaluation-info-card">
            <h3>Participants</h3>
            <h2>{{ count_collected_data }}</h2>
        </div>
        <!-- <div class="evaluation-info-card">
            <h3>Transparency Score</h3>
            <h2>82%</h2>
        </div> -->
    </div>

    <div class="dashboard-navbar">
        <ul>
            <li class="active">Overview</li>
            <li>Evaluated Procedures</li>
            <li>Hotspots</li>
        </ul>
    </div>

    <div class="overview-container active-container">
        <div class="overview-card">
            <div class="overview-header">
                <h2>Overview</h2>
                <p>Summary of the evaluation results, including the number of performed tasks, hotspots, and guidelines score.</p>
            </div>
            <hr class="task-heatmap-divider">
            <div class="scores">
                <!-- Overall Score Section -->
                <div class="overall-score-section">
                    <div class="overall-score-card">
                        <h3>Overall Score</h3>
                        <div class="score-display">
                            <div class="score-number">{{ score_geral }}</div>
                            <div class="transparency-badge {{ transparency_badge_overall|lower|replace(' ', '-') }}">
                                {{ transparency_badge_overall }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Evaluated Procedures Section -->
                <div class="evaluated-procedures-overview">
                    <h3>Evaluated Procedures</h3>
                    <div class="procedures-grid">
                        {% for process in seco_processes %}
                        <div class="procedure-overview-card">
                            <span class="procedure-id">P{{ process.seco_process_id }}</span>
                            <p>{{ process.description }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Software Ecosystems Dimensions Section -->
                <div class="seco-dimensions-section">
                    <h3>Software Ecosystems Dimensions</h3>
                    <div class="dimensions-grid">
                        {% for d in dimension_scores %}
                        <div class="dimension-card">
                            <h4>{{ d.name }}</h4>
                            {% if d.average_score is not none %}
                                <div class="dimension-score">
                                    <span class="score">Score: {{ d.average_score }}</span>
                                    <span class="transparency-badge {{ d.transparency_badge|lower|replace(' ', '-') }}">
                                        {{ d.transparency_badge }}
                                    </span>
                                </div>
                                <div class="procedure-bars">
                                    {% for process in seco_processes %}
                                        {% set procedure_key = 'P' + process.seco_process_id|string %}
                                        {% if d.procedure_scores[procedure_key] and d.procedure_scores[procedure_key] > 0 %}
                                        <div class="procedure-bar">
                                            <span class="procedure-label">P{{ process.seco_process_id }}</span>
                                            <div class="progress-bar">
                                                <div class="progress-fill" data-pct="{{ d.procedure_scores[procedure_key] }}"></div>
                                            </div>
                                            <span class="procedure-score">{{ d.procedure_scores[procedure_key] }}</span>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p>Not related to the evaluation</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Developer Experience Section -->
                <div class="developer-experience-section">
                    <h3>Developer Experience</h3>
                    <div class="dx-grid">
                        {% for category_key, category in dx_categories.items() %}
                        <div class="dx-card">
                            <h4>{{ category.name }}</h4>
                            {% if category.score is not none %}
                                <div class="dx-score">
                                    <span class="score">Score: {{ category.score }}</span>
                                    <span class="transparency-badge {{ category.transparency_badge|lower|replace(' ', '-') }}">
                                        {{ category.transparency_badge }}
                                    </span>
                                </div>
                                <div class="procedure-bars">
                                    {% for process in seco_processes %}
                                        {% set procedure_key = 'P' + process.seco_process_id|string %}
                                        {% if category.procedure_scores[procedure_key] and category.procedure_scores[procedure_key] > 0 %}
                                        <div class="procedure-bar">
                                            <span class="procedure-label">P{{ process.seco_process_id }}</span>
                                            <div class="progress-bar">
                                                <div class="progress-fill" data-pct="{{ category.procedure_scores[procedure_key] }}"></div>
                                            </div>
                                            <span class="procedure-score">{{ category.procedure_scores[procedure_key] }}</span>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p>No data</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="overview-content">
                <div class="overview-profile">
                    <h3>Participants' Profile</h3>
                    <p>Summary of academic background and experience of the evaluation participants.</p>
                    <div class="profilecharts">
                        <div class="academic">
                            <canvas id="experienceChart" style="max-width: 600px; height: 300px;"></canvas>
                        </div>
                        <div class="experience">
                            <canvas id="educationChart" style="max-width: 600px; height: 300px; margin-top: 40px;"></canvas>
                        </div>
                    </div>
                    <p>Based on Carver et al. (2016), participants with less than 3 years of professional experience were categorized in the low experience group, those with 3 to 5 years in the medium experience group, and those with more than 5 years in the high experience group.</p>
                </div>
            </div>
            <div class="aside">
                <div class="word-cloud">
                    <h3>Word Cloud</h3>
                    <p>Word cloud showing the terms most frequently cited by developers throughout the evaluation process.</p>
                    <canvas id="word-cloud"></canvas>
                </div>
                <div class="dev-emotion">
                    <h3>Developer Emotions</h3>
                    <p>Emotional feedback from developers based on their experience interacting with the portal.</p>
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
            <div class="developer-comments">
                <h3>Developer Comments</h3>
                <p>Comments and suggestions from developers after the evaluation process.</p>
                <div class="comments">
                    {% for d in collected_data %}
                    <div class="comment-card">
                        <p><strong>Comment {{ loop.index }}:</strong> {{ d.developer_questionnaire.comments }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="evaluated-procedures-container">
        <div class="procedures-layout">
            <div class="procedures-sidebar">
                <h3>Evaluated Procedures</h3>
                <ul class="procedures-list">
                    {% for process in seco_processes %}
                    <li class="procedure-item {% if loop.first %}active{% endif %}" data-process-id="{{ process.seco_process_id }}">
                        <span class="procedure-id">P{{ process.seco_process_id }}</span>
                        <span class="procedure-description">{{ process.description }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="procedures-content">
                {% for process in seco_processes %}
                <div class="procedure-panel {% if loop.first %}active{% endif %}" data-process-id="{{ process.seco_process_id }}">
                    <div class="procedure-guidelines">
                        <h3>Associated Guidelines</h3>
                        <div class="guidelines-list">
                            {% for guideline in process.guidelines %}
                                {% set g_result = result|selectattr('title', 'equalto', guideline.title)|first|default(None) %}
                                {% if g_result %}
                                <div class="guideline-card">
                                    <h4>{{ guideline.title }}</h4>
                                    <p>{{ guideline.description }}</p>
                                    {% if g_result.average_score is not none %}
                                        <span class="score-badge">Score: {{ g_result.average_score }}%</span>
                                    {% endif %}

                                    <div class="guideline-ksc-section">
                                        <h5>Key Success Criteria:</h5>
                                        {% for ksc in g_result.key_success_criteria %}
                                        <div class="ksc-item">
                                            <h6>{{ ksc.title }}</h6>
                                            <p>{{ ksc.description }}</p>
                                            {% if ksc.score is not none %}
                                                <div class="ksc-score">
                                                    <span>Score: {{ ksc.porcentagem }}%</span>
                                                    <span class="ksc-status {{ ksc.status|lower|replace(' ', '-') }}">{{ ksc.status }}</span>
                                                </div>
                                            {% else %}
                                                <span class="ksc-status no-answers">No Answers</span>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <div class="procedure-tasks">
                        <h3>Associated Tasks</h3>
                        <div class="tasks-accordion">
                            {% set process_tasks = tasks_by_process|selectattr('process_id', 'equalto', process.seco_process_id)|first|default({'tasks': []}) %}
                            {% for task in process_tasks.tasks %}
                                {% set avg_time = task.avg_time if task.avg_time is not none else 0 %}
                                {% set completion_rate = task.completion_rate if task.completion_rate is not none else 0 %}
                                <div class="task-accordion-item">
                                    <div class="task-accordion-header" data-task-id="{{ task.task_id }}">
                                        <span class="task-title">{{ task.title }}</span>
                                        <span class="task-toggle material-symbols-outlined">expand_more</span>
                                    </div>
                                    <div class="task-accordion-content">
                                        <div class="task-metrics">
                                            <div class="metrics-header">
                                                <span>Performance Metrics</span>
                                                <button class="info-btn" onclick="openMetricsModal()">
                                                    <span class="material-symbols-outlined">info</span>
                                                </button>
                                            </div>
                                            <div class="metric-row">
                                                <strong>Average Time:</strong>
                                                <span>{{ avg_time }} seconds</span>
                                                {% if avg_time <= 30 %}
                                                    <span class="badge badge-excellent">Fast</span>
                                                {% elif avg_time <= 60 %}
                                                    <span class="badge badge-good">Moderate</span>
                                                {% elif avg_time <= 120 %}
                                                    <span class="badge badge-warning">Slow</span>
                                                {% else %}
                                                    <span class="badge badge-critical">Very Slow</span>
                                                {% endif %}
                                            </div>
                                            <div class="metric-row">
                                                <strong>Success Rate:</strong>
                                                <span>{{ completion_rate }}%</span>
                                                {% if completion_rate >= 90 %}
                                                    <span class="badge badge-excellent">High Success</span>
                                                {% elif completion_rate >= 70 %}
                                                    <span class="badge badge-good">Good Success</span>
                                                {% elif completion_rate >= 50 %}
                                                    <span class="badge badge-warning">Low Success</span>
                                                {% else %}
                                                    <span class="badge badge-critical">Poor Success</span>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="task-comments-section">
                                            <h4>Developer Comments:</h4>
                                            {% if task.comments %}
                                            <ul class="comments-list">
                                                {% for comment in task.comments %}
                                                    <li>{{ comment }}</li>
                                                {% endfor %}
                                            </ul>
                                            {% else %}
                                            <p class="no-comments">No comments available</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <p class="no-tasks">No tasks associated with this procedure</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Modal de informações sobre métricas -->
    <div id="metricsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Metrics Badge Information</h2>
                <span class="close-modal" onclick="closeMetricsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="metric-info-section">
                    <h3>Time Performance</h3>
                    <div class="metric-info-list">
                        <div class="metric-info-item">
                            <span class="badge badge-excellent">Fast</span>
                            <span>≤ 30 seconds - Excellent performance</span>
                        </div>
                        <div class="metric-info-item">
                            <span class="badge badge-good">Moderate</span>
                            <span>31-60 seconds - Good performance</span>
                        </div>
                        <div class="metric-info-item">
                            <span class="badge badge-warning">Slow</span>
                            <span>61-120 seconds - Needs improvement</span>
                        </div>
                        <div class="metric-info-item">
                            <span class="badge badge-critical">Very Slow</span>
                            <span>> 120 seconds - Critical, requires attention</span>
                        </div>
                    </div>
                </div>

                <div class="metric-info-section">
                    <h3>Success Rate</h3>
                    <div class="metric-info-list">
                        <div class="metric-info-item">
                            <span class="badge badge-excellent">High Success</span>
                            <span>≥ 90% - Excellent completion rate</span>
                        </div>
                        <div class="metric-info-item">
                            <span class="badge badge-good">Good Success</span>
                            <span>70-89% - Good completion rate</span>
                        </div>
                        <div class="metric-info-item">
                            <span class="badge badge-warning">Low Success</span>
                            <span>50-69% - Below average completion</span>
                        </div>
                        <div class="metric-info-item">
                            <span class="badge badge-critical">Poor Success</span>
                            <span>< 50% - Critical, needs urgent attention</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- elemento escondido com o id da avaliação (usado pelo JS) -->
    <p id="id-avaliacao" style="display:none">{{ evaluation.evaluation_id }}</p>

    <div class="hotspots-container">
        <div class="hotspot-card">
            <div class="hotspots-header">
            <h2>Heatmaps by Task</h2>
            <p>Viewing participant interactions mapped to specific tasks.</p>
            </div>

            <div class="task-heatmap-container">
            <hr class="task-heatmap-divider">

            <!-- Filtros de tarefas -->
            <div class="task-filters-container">
                <h3>Filter by Task</h3>
                <div class="task-filters" id="task-filters">
                    <div class="filter-item">
                        <input type="checkbox" id="filter-all" checked>
                        <label for="filter-all">Show All Tasks</label>
                    </div>
                    <!-- Filtros específicos serão inseridos aqui via JavaScript -->
                </div>
            </div>

            <!-- raiz onde os heatmaps vindos da API serão inseridos -->
            <div id="heatmaps-root" class="heatmaps">
                <p class="loading">Loading heatmaps...</p>
            </div>

            </div>
        </div>
    </div>


</div>


{% endblock %}
{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.1.2/src/wordcloud2.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.min.js"></script>
    <script src="{{ url_for('static', filename='js/hotspots_heatmaps.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.percentage-bar .bar-fill').forEach(function (el) {
                var pct = el.getAttribute('data-pct');
                if (pct !== null && pct !== '') {
                    var value = parseFloat(pct);
                    if (!isNaN(value)) {
                        el.style.width = value + '%';
                    }
                }
            });
        });
    </script>
{% endblock %}
