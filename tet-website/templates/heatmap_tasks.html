<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heatmaps by Task - Evaluation {{ evaluation_id }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .task-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .task-header {
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .task-title {
            color: #007bff;
            font-size: 1.5em;
            margin: 0;
        }
        .task-description {
            color: #666;
            margin: 5px 0 0 0;
        }
        .heatmap-container {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        .heatmap-info {
            background: #f8f9fa;
            padding: 10px;
            border-top: 1px solid #ddd;
            font-size: 0.9em;
            color: #666;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .stat-item {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .no-data {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Heatmaps by Task</h1>
        <p>Evaluation ID: <strong>{{ evaluation_id }}</strong></p>
        <div id="loading" class="loading">Loading heatmap data...</div>
        <div id="error" class="error" style="display: none;"></div>
    </div>

    <div id="content" style="display: none;">
        <div id="stats" class="stats"></div>
        <div id="tasks-container"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.min.js"></script>
    <script>
        const evaluationId = {{ evaluation_id }};
        
        // Load heatmap data
        fetch(`/api/heatmap-tasks/${evaluationId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Heatmap data received:', data);
                displayHeatmaps(data);
            })
            .catch(error => {
                console.error('Error loading heatmap data:', error);
                showError('Failed to load heatmap data: ' + error.message);
            });

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        function displayHeatmaps(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            // Display metadata
            const stats = document.getElementById('stats');
            if (data.metadata) {
                stats.innerHTML = `
                    <div class="stat-item">Tasks with heatmaps: ${data.metadata.total_tasks_with_heatmaps || 0}</div>
                    <div class="stat-item">Total heatmaps: ${data.metadata.total_heatmaps || 0}</div>
                    <div class="stat-item">Total points: ${data.metadata.total_points_processed || 0}</div>
                    <div class="stat-item">Navigation data: ${data.metadata.navigation_data_count || 0}</div>
                    <div class="stat-item">Method: ${data.metadata.segmentation_method || 'unknown'}</div>
                `;
            }

            const container = document.getElementById('tasks-container');
            
            if (!data.segmented_heatmaps || Object.keys(data.segmented_heatmaps).length === 0) {
                container.innerHTML = '<div class="no-data">No heatmap data available for this evaluation.</div>';
                return;
            }

            // Display each task's heatmaps
            Object.entries(data.segmented_heatmaps).forEach(([taskId, taskData]) => {
                const taskSection = document.createElement('div');
                taskSection.className = 'task-section';
                
                taskSection.innerHTML = `
                    <div class="task-header">
                        <h2 class="task-title">Task ${taskId}: ${taskData.task_info.title}</h2>
                        <p class="task-description">${taskData.task_info.description || 'No description available'}</p>
                    </div>
                    <div class="heatmaps-container" id="heatmaps-${taskId}"></div>
                `;
                
                container.appendChild(taskSection);
                
                // Display heatmaps for this task
                const heatmapsContainer = document.getElementById(`heatmaps-${taskId}`);
                
                if (taskData.heatmaps.length === 0) {
                    heatmapsContainer.innerHTML = '<div class="no-data">No heatmaps available for this task.</div>';
                    return;
                }
                
                taskData.heatmaps.forEach((heatmap, index) => {
                    const heatmapDiv = document.createElement('div');
                    heatmapDiv.className = 'heatmap-container';
                    
                    const width = heatmap.width || 800;
                    const height = heatmap.height || 600;
                    
                    heatmapDiv.style.width = `${width}px`;
                    heatmapDiv.style.height = `${height}px`;
                    
                    // Create background image
                    const img = document.createElement('img');
                    img.src = `data:image/jpeg;base64,${heatmap.image}`;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'contain';
                    heatmapDiv.appendChild(img);
                    
                    // Create heatmap overlay
                    const heatmapInstance = h337.create({
                        container: heatmapDiv,
                        radius: 50,
                        maxOpacity: 0.6,
                        blur: 0.9,
                    });
                    
                    // Process points
                    const processedPoints = (heatmap.points || []).map(point => ({
                        x: Math.round(point.x || 0),
                        y: Math.round(point.y || 0),
                        value: Math.round((point.intensity || 0) * 700)
                    })).filter(point => point.value > 0);
                    
                    if (processedPoints.length > 0) {
                        heatmapInstance.setData({
                            max: 1000,
                            data: processedPoints
                        });
                    }
                    
                    // Add heatmap info
                    const info = document.createElement('div');
                    info.className = 'heatmap-info';
                    info.innerHTML = `
                        <strong>URL:</strong> ${heatmap.url || 'Unknown'} | 
                        <strong>Points:</strong> ${processedPoints.length} | 
                        <strong>Dimensions:</strong> ${width}x${height}
                    `;
                    heatmapDiv.appendChild(info);
                    
                    heatmapsContainer.appendChild(heatmapDiv);
                });
            });
        }
    </script>
</body>
</html>




